sap.ui.define([                                                                                                                                                                                                                                                
    "./BaseController",                                                                                                                                                                                                                                        
    "sap/ui/model/json/JSONModel",                                                                                                                                                                                                                             
    "../model/formatter",                                                                                                                                                                                                                                      
    "sap/m/library",                                                                                                                                                                                                                                           
    "sap/m/MessageBox",                                                                                                                                                                                                                                        
    "sap/ui/model/Filter",                                                                                                                                                                                                                                     
    "sap/ui/model/FilterOperator",                                                                                                                                                                                                                             
    'sap/ui/core/Fragment',                                                                                                                                                                                                                                    
    "sap/ui/Device"                                                                                                                                                                                                                                            
], function (BaseController, JSONModel, formatter, mobileLibrary, MessageBox, Filter, FilterOperator, Fragment, Device) {                                                                                                                                      
    "use strict";                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                               
    // shortcut for sap.m.URLHelper                                                                                                                                                                                                                            
    var URLHelper = mobileLibrary.URLHelper;                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                               
    return BaseController.extend("translations.controller.Detail", {                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
        formatter: formatter,                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                               
        /* =========================================================== */                                                                                                                                                                                      
        /* lifecycle methods                                           */                                                                                                                                                                                      
        /* =========================================================== */                                                                                                                                                                                      
                                                                                                                                                                                                                                                               
        onInit: function () {                                                                                                                                                                                                                                  
            // Model used to manipulate control states. The chosen values make sure,                                                                                                                                                                           
            // detail page is busy indication immediately so there is no break in                                                                                                                                                                              
            // between the busy indication for loading the view's meta data                                                                                                                                                                                    
            var oViewModel = new JSONModel({                                                                                                                                                                                                                   
                busy: false,                                                                                                                                                                                                                                   
                delay: 0,                                                                                                                                                                                                                                      
                rowCount: 0                                                                                                                                                                                                                                    
            });                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                               
            this.getRouter().getRoute("object").attachPatternMatched(this._onObjectMatched, this);                                                                                                                                                             
                                                                                                                                                                                                                                                               
            this.setModel(oViewModel, "detailView");                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
            this.getOwnerComponent().getModel("translation").metadataLoaded().then(this._onMetadataLoaded.bind(this));                                                                                                                                         
        },                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
        handleExitFullScreen: function () {                                                                                                                                                                                                                    
            var bReplace = !Device.system.phone;                                                                                                                                                                                                               
            // set the layout property of FCL control to show two columns                                                                                                                                                                                      
            this.getModel("appView").setProperty("/layout", "MidColumnFullScreen");                                                                                                                                                                            
            this.getRouter().navTo("object", {                                                                                                                                                                                                                 
                layout: "OneColumn",                                                                                                                                                                                                                           
                objectId: "ZPM_C_EEQUIP"                                                                                                                                                                                                                       
            }, bReplace);                                                                                                                                                                                                                                      
        },                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
        /* =========================================================== */                                                                                                                                                                                      
        /* event handlers                                              */                                                                                                                                                                                      
        /* =========================================================== */                                                                                                                                                                                      
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                                                                                                                                                                                               
        onSelectTransport: async function (oEvent) {                                                                                                                                                                                                           
            if (await this._checkUnsavedChanges()) {                                                                                                                                                                                                           
                var oView = this.getView();                                                                                                                                                                                                                    
                if (!this._pTransportSelectionDialog) {                                                                                                                                                                                                        
                    this._pTransportSelectionDialog = Fragment.load({                                                                                                                                                                                          
                        id: oView.getId(),                                                                                                                                                                                                                     
                        name: "translations.view.fragment.TransportSelectionDialog",                                                                                                                                                                           
                        controller: this                                                                                                                                                                                                                       
                    }).then(function (oValueHelpDialog) {                                                                                                                                                                                                      
                        oView.addDependent(oValueHelpDialog);                                                                                                                                                                                                  
                        return oValueHelpDialog;                                                                                                                                                                                                               
                    });                                                                                                                                                                                                                                        
                }                                                                                                                                                                                                                                              
                this._pTransportSelectionDialog.then(function (oValueHelpDialog) {                                                                                                                                                                             
                    oValueHelpDialog.open();                                                                                                                                                                                                                   
                }.bind(this));                                                                                                                                                                                                                                 
            }                                                                                                                                                                                                                                                  
        },                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
        handleSearchTR: function (oEvent) {                                                                                                                                                                                                                    
            var sValue = oEvent.getParameter("value");                                                                                                                                                                                                         
            var oFilter = new Filter("As4text", FilterOperator.Contains, sValue);                                                                                                                                                                              
            var oBinding = oEvent.getSource().getBinding("items");                                                                                                                                                                                             
            oBinding.filter([oFilter]);                                                                                                                                                                                                                        
        },                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
        handleTRValueHelpClose: function (oEvent) {                                                                                                                                                                                                            
            var oBinding = oEvent.getSource().getBinding("items"),                                                                                                                                                                                             
                oResourceBundle = this.getOwnerComponent().getModel('i18n').getResourceBundle(),                                                                                                                                                               
                aContexts = oEvent.getParameter("selectedContexts");                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
            oBinding.filter([]);                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
            if (aContexts && aContexts.length) {                                                                                                                                                                                                               
                let sTR = aContexts[0].getObject().Trkorr,                                                                                                                                                                                                     
                    sCDS = this.getView().getBindingContext('translation').getObject().Ddlxname;                                                                                                                                                               
                this.getView().getModel("translation").callFunction("/Transport", {                                                                                                                                                                            
                    method: "POST", urlParameters: { "Ddlxname": sCDS, "Cds": sCDS, "Transport": sTR },                                                                                                                                                        
                    success: function () {                                                                                                                                                                                                                     
                        MessageBox.success(oResourceBundle.getText("transportSuccess"));                                                                                                                                                                       
                                                                                                                                                                                                                                                               
                    },                                                                                                                                                                                                                                         
                    error: function () {                                                                                                                                                                                                                       
                        MessageBox.error(oResourceBundle.getText("transportError"));                                                                                                                                                                           
                    }                                                                                                                                                                                                                                          
                })                                                                                                                                                                                                                                             
            }                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                               
        },                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
        onSave: function (oEvent) {                                                                                                                                                                                                                            
            let oResourceBundle = this.getOwnerComponent().getModel('i18n').getResourceBundle();                                                                                                                                                               
            let oModel = this.getModel("translation");                                                                                                                                                                                                         
            if (oModel.hasPendingChanges()) {                                                                                                                                                                                                                  
                this._setBusy(true);                                                                                                                                                                                                                           
                oModel.submitChanges({                                                                                                                                                                                                                         
                    success: function (oData) {                                                                                                                                                                                                                
                        MessageBox.success(oResourceBundle.getText("saveSuccess"));                                                                                                                                                                            
                        this._setBusy(false);                                                                                                                                                                                                                  
                    }.bind(this),                                                                                                                                                                                                                              
                    error: function (oError) {                                                                                                                                                                                                                 
                        MessageBox.error(oResourceBundle.getText("saveError"));                                                                                                                                                                                
                        this._setBusy(false);                                                                                                                                                                                                                  
                    }                                                                                                                                                                                                                                          
                });                                                                                                                                                                                                                                            
            } else {                                                                                                                                                                                                                                           
                MessageBox.warning(oResourceBundle.getText("noChanges"));                                                                                                                                                                                      
            }                                                                                                                                                                                                                                                  
        },                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
        formatHighlight: function (sEN, sNL, sFR, sDE) {                                                                                                                                                                                                       
            if (sEN === null) {                                                                                                                                                                                                                                
                return "None";                                                                                                                                                                                                                                 
            } else if (sEN && sNL && sFR && sDE) {                                                                                                                                                                                                             
                return "Success";                                                                                                                                                                                                                              
            }                                                                                                                                                                                                                                                  
            return "Warning";                                                                                                                                                                                                                                  
        },                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
        onFilterTranslations: function (oEvent) {                                                                                                                                                                                                              
            var sQuery = oEvent.getParameter("query"),                                                                                                                                                                                                         
                aFilters = []                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                               
            if (sQuery) {                                                                                                                                                                                                                                      
                aFilters = [new Filter("Element", FilterOperator.Contains, sQuery)];                                                                                                                                                                           
            } else {                                                                                                                                                                                                                                           
                aFilters = [];                                                                                                                                                                                                                                 
            }                                                                                                                                                                                                                                                  
            this.getView().byId('table').getBinding('rows').filter(aFilters);                                                                                                                                                                                  
        },                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
        onValueChange: function (oEvent) {                                                                                                                                                                                                                     
            let sPath = oEvent.getSource().getBindingContext('translation').getPath();                                                                                                                                                                         
                                                                                                                                                                                                                                                               
            if (oEvent.getSource().getBinding("value").vOriginalValue !== oEvent.getParameter('value')) {                                                                                                                                                      
                this.getView().getModel('translation').setProperty(sPath + "/" + oEvent.getSource().getBinding("value").sPath + 'Changed', true);                                                                                                              
            } else {                                                                                                                                                                                                                                           
                this.getView().getModel('translation').setProperty(sPath + "/" + oEvent.getSource().getBinding("value").sPath + 'Changed', false);                                                                                                             
            }                                                                                                                                                                                                                                                  
        },                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
        /**                                                                                                                                                                                                                                                    
         * Set the full screen mode to false and navigate to list page                                                                                                                                                                                         
         */                                                                                                                                                                                                                                                    
        onCloseDetailPress: function () {                                                                                                                                                                                                                      
            this.getModel("appView").setProperty("/actionButtonsInfo/midColumn/fullScreen", false);                                                                                                                                                            
            // No item should be selected on list after detail page is closed                                                                                                                                                                                  
            this.getOwnerComponent().oListSelector.clearListListSelection();                                                                                                                                                                                   
            this.getRouter().navTo("list");                                                                                                                                                                                                                    
        },                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
        /**                                                                                                                                                                                                                                                    
         * Toggle between full and non full screen mode.                                                                                                                                                                                                       
         */                                                                                                                                                                                                                                                    
        toggleFullScreen: function () {                                                                                                                                                                                                                        
            var bFullScreen = this.getModel("appView").getProperty("/actionButtonsInfo/midColumn/fullScreen");                                                                                                                                                 
            this.getModel("appView").setProperty("/actionButtonsInfo/midColumn/fullScreen", !bFullScreen);                                                                                                                                                     
            if (!bFullScreen) {                                                                                                                                                                                                                                
                // store current layout and go full screen                                                                                                                                                                                                     
                this.getModel("appView").setProperty("/previousLayout", this.getModel("appView").getProperty("/layout"));                                                                                                                                      
                this.getModel("appView").setProperty("/layout", "MidColumnFullScreen");                                                                                                                                                                        
            } else {                                                                                                                                                                                                                                           
                // reset to previous layout                                                                                                                                                                                                                    
                this.getModel("appView").setProperty("/layout", this.getModel("appView").getProperty("/previousLayout"));                                                                                                                                      
            }                                                                                                                                                                                                                                                  
        },                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
        /* =========================================================== */                                                                                                                                                                                      
        /* begin: internal methods                                     */                                                                                                                                                                                      
        /* =========================================================== */                                                                                                                                                                                      
                                                                                                                                                                                                                                                               
        /**                                                                                                                                                                                                                                                    
         * Binds the view to the object path and expands the aggregated line items.                                                                                                                                                                            
         * @function                                                                                                                                                                                                                                           
         * @param {sap.ui.base.Event} oEvent pattern match event in route 'object'                                                                                                                                                                             
         * @private                                                                                                                                                                                                                                            
         */                                                                                                                                                                                                                                                    
        _onObjectMatched: function (oEvent) {                                                                                                                                                                                                                  
            var sObjectId = oEvent.getParameter("arguments").objectId;                                                                                                                                                                                         
            this.getModel("appView").setProperty("/layout", "TwoColumnsMidExpanded");                                                                                                                                                                          
                                                                                                                                                                                                                                                               
            this.getModel("translation").metadataLoaded().then(function () {                                                                                                                                                                                   
                this.getModel("translation").resetChanges();                                                                                                                                                                                                   
                let oModel = this.getView().getModel("translation");                                                                                                                                                                                           
                oModel.setUseBatch(true);                                                                                                                                                                                                                      
                oModel.setDefaultBindingMode(sap.ui.model.BindingMode.TwoWay);                                                                                                                                                                                 
                var sObjectPath = this.getModel("translation").createKey("CDS", {                                                                                                                                                                              
                    Ddlxname: sObjectId                                                                                                                                                                                                                        
                });                                                                                                                                                                                                                                            
                this._bindView("translation>/" + sObjectPath);                                                                                                                                                                                                 
            }.bind(this));                                                                                                                                                                                                                                     
        },                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
        /**                                                                                                                                                                                                                                                    
         * Binds the view to the object path. Makes sure that detail view displays                                                                                                                                                                             
         * a busy indicator while data for the corresponding element binding is loaded.                                                                                                                                                                        
         * @function                                                                                                                                                                                                                                           
         * @param {string} sObjectPath path to the object to be bound to the view.                                                                                                                                                                             
         * @private                                                                                                                                                                                                                                            
         */                                                                                                                                                                                                                                                    
        _bindView: function (sObjectPath) {                                                                                                                                                                                                                    
            // Set busy indicator during view binding                                                                                                                                                                                                          
            this._setBusy(false);                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                               
            this.getView().bindElement({                                                                                                                                                                                                                       
                path: sObjectPath,                                                                                                                                                                                                                             
                events: {                                                                                                                                                                                                                                      
                    change: this._onBindingChange.bind(this),                                                                                                                                                                                                  
                    dataRequested: function () {                                                                                                                                                                                                               
                        this._setBusy(true);                                                                                                                                                                                                                   
                    }.bind(this),                                                                                                                                                                                                                              
                    dataReceived: function (oEvent) {                                                                                                                                                                                                          
                        this._setBusy(false);                                                                                                                                                                                                                  
                    }.bind(this)                                                                                                                                                                                                                               
                }                                                                                                                                                                                                                                              
            });                                                                                                                                                                                                                                                
        },                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
        _onBindingChange: function () {                                                                                                                                                                                                                        
            var oView = this.getView(),                                                                                                                                                                                                                        
                oElementBinding = oView.getElementBinding("translation");                                                                                                                                                                                      
                                                                                                                                                                                                                                                               
            // No data for the binding                                                                                                                                                                                                                         
            if (!oElementBinding.getBoundContext("translation")) {                                                                                                                                                                                             
                this.getRouter().getTargets().display("detailObjectNotFound");                                                                                                                                                                                 
                // if object could not be found, the selection in the list                                                                                                                                                                                     
                // does not make sense anymore.                                                                                                                                                                                                                
                this.getOwnerComponent().oListSelector.clearListListSelection();                                                                                                                                                                               
                return;                                                                                                                                                                                                                                        
            }                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                               
            var sPath = oElementBinding.getPath(),                                                                                                                                                                                                             
                oResourceBundle = this.getResourceBundle(),                                                                                                                                                                                                    
                oObject = oView.getModel("translation").getObject(sPath),                                                                                                                                                                                      
                sObjectId = oObject.Ddlxname,                                                                                                                                                                                                                  
                sObjectName = oObject.Ddlxname,                                                                                                                                                                                                                
                oViewModel = this.getModel("detailView");                                                                                                                                                                                                      
                                                                                                                                                                                                                                                               
            this.getOwnerComponent().oListSelector.selectAListItem(sPath);                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
            let oRowsBinding = this.getView().byId("table").getBinding('rows');                                                                                                                                                                                
            oRowsBinding.attachChange(function () {                                                                                                                                                                                                            
                let iLength = oRowsBinding.getLength();                                                                                                                                                                                                        
                oViewModel.setProperty('/numberOfLines', iLength);                                                                                                                                                                                             
            })                                                                                                                                                                                                                                                 
        },                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
        _onMetadataLoaded: function () {                                                                                                                                                                                                                       
            // Store original busy indicator delay for the detail view                                                                                                                                                                                         
            var iOriginalViewBusyDelay = this.getView().getBusyIndicatorDelay(),                                                                                                                                                                               
                oViewModel = this.getModel("detailView");                                                                                                                                                                                                      
                                                                                                                                                                                                                                                               
            // Make sure busy indicator is displayed immediately when                                                                                                                                                                                          
            // detail view is displayed for the first time                                                                                                                                                                                                     
            oViewModel.setProperty("/delay", 0);                                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
            // Binding the view will set it to not busy - so the view is always busy if it is not bound                                                                                                                                                        
            this._setBusy(true);                                                                                                                                                                                                                               
            // Restore original busy indicator delay for the detail view                                                                                                                                                                                       
            oViewModel.setProperty("/delay", iOriginalViewBusyDelay);                                                                                                                                                                                          
        },                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
        _checkUnsavedChanges: async function () {                                                                                                                                                                                                              
            let oModel = this.getModel("translation");                                                                                                                                                                                                         
                                                                                                                                                                                                                                                               
            return new Promise((resolve, reject) => {                                                                                                                                                                                                          
                if (oModel.hasPendingChanges()) {                                                                                                                                                                                                              
                    let oResourceBundle = this.getOwnerComponent().getModel('i18n').getResourceBundle();                                                                                                                                                       
                    MessageBox.warning("There are unsaved changes. Are you sure you want to transport?", {                                                                                                                                                     
                        actions: [MessageBox.Action.OK, MessageBox.Action.CANCEL],                                                                                                                                                                             
                        emphasizedAction: MessageBox.Action.OK,                                                                                                                                                                                                
                        onClose: function (sAction) {                                                                                                                                                                                                          
                            if (sAction === 'CANCEL') {                                                                                                                                                                                                        
                                resolve(false);                                                                                                                                                                                                                
                            } else {                                                                                                                                                                                                                           
                                resolve(true);                                                                                                                                                                                                                 
                            }                                                                                                                                                                                                                                  
                        }                                                                                                                                                                                                                                      
                    });                                                                                                                                                                                                                                        
                } else {                                                                                                                                                                                                                                       
                    resolve( true);                                                                                                                                                                                                                            
                }                                                                                                                                                                                                                                              
            });                                                                                                                                                                                                                                                
        },                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
        _setBusy: function(bBusy){                                                                                                                                                                                                                             
            this.getModel("detailView").setProperty('/busy', bBusy);                                                                                                                                                                                           
        }                                                                                                                                                                                                                                                      
    });                                                                                                                                                                                                                                                        
});                                                                                                                                                                                                                                                            